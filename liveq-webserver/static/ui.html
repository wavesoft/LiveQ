<!DOCTYPE html>
<html>
  <head>
    <title>LiveQ Framework Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="lib/bs/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="lib/d3.v3.min.js"></script>
    <script type="text/javascript" src="lab.js.src/LiveQ.js"></script>
    <script type="text/javascript" src="lab.js.src/BufferReader.js"></script>
    <script type="text/javascript" src="lab.js.src/HistogramData.js"></script>
    <script type="text/javascript" src="lab.js.src/ReferenceData.js"></script>
    <script type="text/javascript" src="lab.js.src/LabProtocol.js"></script>
    <script type="text/javascript" src="lab.js.src/LabSocket.js"></script>
    <script type="text/javascript" src="lab.js.src/Plot.js"></script>
    <script type="text/javascript" src="lab.js.src/PlotHistogram.js"></script>

    <style type="text/css">

    /* =========== */
    /*   Website    */
    /* =========== */

    body {
      font: sans-serif;
      padding-top: 70px;
      background: url(img/background.jpg) #000 no-repeat top center;
      background-attachment: fixed;
    }

    div#log {
      height: 100px;
      overflow: auto;
      font-family: "Lucida Console", Monaco, monospace;
      font-size: 10px;
    }

    div#log div:first {
      font-weight: bold;
    }

    div#log .warn {
      color: #F60;
    }

    div#log .error {
      color: #F00;
    }

    div#log .done {
      color: #060;
    }

    div#log .info {
      color: #06F;
    }

    span.description {
      display: none;
    }

    span.running-text {
      color: #F00;
      font-size: 0.6em;
    }

    iframe#inlineModalFrame {
      border: none;
      width: 100%;
      height: 300px;
    }

    div.color-legend > div.cl {
      width: 12px;
      height: 12px;
      display: inline-block;
      border: solid 1px #666;
      vertical-align: middle;
    }

    /* =========== */
    /*  Histogram   */
    /* =========== */

    #host svg {
      font: 10px sans-serif;
      padding: 8px;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    path.plot-line {
      fill: none;
    }
    path.plot-area {
      stroke: none;
    }
    path.plot-bullet {
      fill: #fff;
    }

    </style>

    <script type="text/javascript">

    // #################################################################################
    // =================================================================================
    //                                EVENT COUNTER
    // =================================================================================
    // #################################################################################

    function EventCounter() {
      this.lastTime = 0;
      this.lastNevts = 0;
    };

    /**
     */
    EventCounter.prototype.update = function(nevts) {
      var now = new Date().getTime() / 1000;

    }

    /**
     */
    EventCounter.prototype.start = function(nevts) {
      var now = new Date().getTime() / 1000;
      this.lastTime = now;
      this.lastNevts = 0;
      this.step = 1;
    }

    /**
     */
    EventCounter.prototype.onUpdate = function(v) {

    }

    function commaThousands(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // #################################################################################
    // =================================================================================
    //                                  DEMO LAB
    // =================================================================================
    // #################################################################################

    function getTS() {
      var d = new Date();
      return  ('0' + d.getHours()).slice(-2) + ":" +
              ('0' + d.getMinutes()).slice(-2) + ":" +
              ('0' + d.getSeconds()).slice(-2);
    }

    function addLog(html, cls) {
      var logLine = $('<div></div>');
      if (!cls) cls="";
      $(logLine).attr("class", cls);
      $(logLine).html("["+getTS()+"]: "+html);
      $("#log").prepend(logLine);
    }

    function popoverInline(url) {
      $("#inlineModalFrame").attr("href", url);
      $("#inlineModal").modal('show');
    }

    var site;
    function initialize() {

      // Bind descriptions
      $("#tunables > form > .form-group").each(function(i, e) {
        var input = $(e).find("input").first(),
            desc = $(e).find(".description").first().html();

        // Create popover on the description
        $(input).popover({
          'html': true,
          'content': desc,
          'trigger': 'focus',
          'placement': 'bottom'
        });

        // Open links in the popover on an inline popover
        var link = $(desc).find("a").first();
        link.click(function(e){
          e.preventDefault();
          popoverInline(link.attr("href"));
          return false;
        });

      });

      // Establish connection to the lab
      var lab = new LiveQ.LabSocket("3eb1263a77f35ba11d334cc8e29fc0c3");

      // Register handlers for new histograms
      lab.onHistogramAdded(function(histo, ref) {

        // Create a new plot and store it in the histogram object
        histo.plot = new LiveQ.PlotWindow("#host", {
            'width': 340,
            'height': 300,
            'imgTitle': ref.imgTitle,
            'imgXLabel': ref.imgXLabel,
            'imgYLabel': ref.imgYLabel
          });

        // Place the reference data
        histo.plot.addHistogram( ref.reference, "Reference data" )

        // Place histogram
        histo.plot.addHistogram( histo, ref.name );

      });

      // Redraw histogram when updated
      lab.onHistogramUpdate(function(histo, ref) {

        // Update plot
        histo.plot.update();

      });

      // Log messages
      lab.onLog(function(msg) {
        addLog(msg);
      });

      // Log errors
      lab.onError(function(msg) {
        addLog(msg, "error");
      });

      // Handle completion
      lab.onCompleted(function() {
        addLog("Simulation completed", "done");
        $("#stopSim").hide();
        $("#loading-spinner").hide();
      });

      // Handle metadata update
      lab.onMetadataUpdated(function(meta) {
        if (meta['interpolation']) {
          $("#nevts").html( commaThousands(meta['nevts']) + ' <span class="text-primary"> (Interpolation)</span>' );
        } else {
          $("#nevts").html( commaThousands(meta['nevts']) );
        }
      });

      // Open main lab
      addLog("Initialized socket on lab " + lab.id);

      // Bind buttons
      $("#startSim").click(function(e,i) {
        var param = {
            'TimeShower:alphaSvalue': parseFloat($("#tunable-01").val()),
            'StringZ:aLund': parseFloat($("#tunable-02").val()),
            'StringZ:bLund': parseFloat($("#tunable-03").val()),
          };
        addLog("Starting simulation");
        lab.beginSimulation( param );
        $("#stopSim").show();
        $("#loading-spinner").show();
      });

      // Bind abort button
      $("#stopSim").click(function(e,i) {
        addLog("Aborting simulation", "warn");
        lab.abortSimulation();
        $("#stopSim").hide();
        $("#loading-spinner").hide();
      });

      // Hide stop sim and spinner
      $("#stopSim").hide();
      $("#loading-spinner").hide();

    }

    </script>    

  </head>
  <body>

    <div class="container">
      <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">LiveQ Framework</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle active" data-toggle="dropdown">Play <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#">AlphaS - T</a></li>
              </ul>
            </li>
            <li><a href="#">Configure</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="row">
        <div class="col-md-6">

          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Tunables</h3>
            </div>
            <div class="panel-body" id="tunables">

              <form class="form-horizontal" role="form">

                <div class="form-group">
                  <label for="tunable-01" class="col-sm-6 control-label">TimeShower:alphaSvalue</label>
                  <div class="col-sm-6">
                    <input type="text" class="form-control" id="tunable-01" value="0.14">
                    <span class="description">
                      <p>The alpha_strong value at scale <code>M_Z^2</code>.</p>
                      <p>The default value corresponds to a crude tuning to LEP data, to be improved. The actual value is then regulated by the running to the scale <code>pT^2</code>, at which the shower evaluates alpha_strong.</p>
                      <p><a href="#http://home.thep.lu.se/~torbjorn/pythia81html/Fragmentation.html">More information</a></p>
                    </span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="tunable-02" class="col-sm-6 control-label">StringZ:aLund</label>
                  <div class="col-sm-6">
                    <input type="text" class="form-control" id="tunable-02" value="0.3">
                    <span class="description">
                      <p>The <code>a</code> parameter of the Lund symmetric fragmentation function.</p>
                      <p>The Lund symmetric fragmentation function is the only alternative for light quarks. It is of the form 
                          <code>f(z) = (1/z) * (1-z)^a * exp(-b m_T^2 / z)</code>
                          with the two main free parameters a and b to be tuned to data
                      </p>
                    </span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="tunable-03" class="col-sm-6 control-label">StringZ:bLund</label>
                  <div class="col-sm-6">
                    <input type="text" class="form-control" id="tunable-03" value="0.8">
                    <span class="description">
                      <p>The <code>b</code> parameter of the Lund symmetric fragmentation function.</p>
                      <p>The Lund symmetric fragmentation function is the only alternative for light quarks. It is of the form 
                          <code>f(z) = (1/z) * (1-z)^a * exp(-b m_T^2 / z)</code>
                          with the two main free parameters a and b to be tuned to data
                      </p>
                    </span>
                  </div>
                </div>

                <div class="form-group">
                  <div class="col-sm-offset-6 col-sm-6">
                    <button id="startSim" type="button" class="btn btn-success"><span class="glyphicon glyphicon-check"></span> Try these values</button>
                    <button id="stopSim" type="button" class="btn btn-danger"><span class="glyphicon glyphicon-remove"></span></button>
                  </div>
                </div>

              </form>

            </div>
          </div>


        </div>
        <div class="col-md-6">

          <div class="panel panel-default hidden-xs">
            <div class="panel-heading">
              <h3 class="panel-title">Log</h3>
            </div>
            <div class="panel-body" id="log">
              &nbsp;
            </div>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Information</h3>
            </div>
            <div class="panel-body">

              <form class="form-horizontal" role="form">

                <div class="form-group">
                  <label class="col-sm-4 control-label">No. of events:</label>
                  <div class="col-sm-8">
                    <p class="form-control-static" id="nevts">0</p>
                  </div>
                </div>

              </form>

            </div>
          </div>

        </div>
      </div>



      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Observables <span id="loading-spinner" class="pull-right"><span class="running-text">Simulation running</small> &nbsp; <img src="img/spinner.gif" alt="Loading" /></span></h3>
        </div>
        <div class="panel-body" id="host">
          &nbsp;
        </div>
        <div class="panel-footer color-legend small">
          <div class="cl" style="background: #999"></div> No data,
          <div class="cl" style="background: #FFF"></div> &sigma; &le; 0.1,
          <div class="cl" style="background: #FF0"></div> &sigma; = 1,
          <div class="cl" style="background: #F00"></div> &sigma; &ge;= 4
        </div>
      </div>


      <!-- In-line modal window -->
      <div class="modal fade" id="inlineModal" tabindex="-1" role="dialog" aria-labelledby="inlineModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h4 class="modal-title" id="inlineModalLabel">Modal title</h4>
            </div>
            <div class="modal-body">
              <iframe id="inlineModalFrame" border="0"></iframe>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="lib/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="lib/bs/js/bootstrap.min.js"></script>
    <script>initialize();</script>

  </body>
</html>
